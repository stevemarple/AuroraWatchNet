\chapter{Raspberry Pi setup}

\section[SD card creation]{\sd\ card creation}

If your SD card already contains Raspbian you can skip to
section~\ref{sec:configuring-raspbian}.

Download the latest Raspbian image and copy to the \sd\ card following
the \href{http://www.raspberrypi.org/downloads}{instructions} on the
Raspberry Pi web site. \textbf{Copying the compressed image to a \fat\
  partition on the \sd\ card will not work}.

These instructions assume Debian 8 (``Jessie'') is used.

\section{Configuring Raspbian}
\label{sec:configuring-raspbian}
\helpbox{In the command window you can press the \keypress{Tab} key
  to have Linux complete the command or filename.}

\helpbox{If you are not familiar with the \code{nano} text editor read
  \href{http://www.howtogeek.com/howto/42980/the-beginners-guide-to-nano-the-linux-command-line-text-editor/}{The Beginner's Guide to Nano, the Linux Command-Line Text Editor}}

Raspbian is most easily configured by booting the new image. If you
are able to discover the \ip\ address (for instance, by checking the
\dhcp\ tables of your home router) you can do this over the network
using \ssh. Otherwise you must use attach a keyboard and monitor to the
Raspberry Pi. If you are familiar with Linux it is also possible to
edit the files by mounting the \sd\ card on another Linux system.


\subsection{Raspbian configuration}

Log in as \piUser\ and run
\begin{Cmd}
sudo raspi-config
\end{Cmd}

\subsubsection{Change user password}
\textbf{If the default password has not been changed then do so now to keep
your system secure.}

\subsubsection{Internationalisation options}
\filename{cron} uses local time and the shift to and from daylight
saving time complicates the \filename{cron} tables. Set the Raspberry
Pi's timezone to \utc\ to avoid daylight saving.

Select \code{Internationalisation Options} and
then \code{Change Timezone}. For geographic area select %
\code{None of the above}, then select \code{\utc}. Select \code{OK}.

\subsubsection{Hostname} 

If you wish change the hostname of your Raspberry Pi select
\code{Advanced Options} and then \code{Hostname}.

If you have multiple Raspberry Pi computers on your netowrk then you
should arrange for them to have unique hostnames. Our preference is to
set the hostname to \code{awn-xxx}, where \code{xxx} is the
abbreviation (typically 3 letters) used for the magnetometer site.

\subsubsection{Memory split}
Select \code{Advanced Options} and then \code{Memory
  Split}. Set the \gpu\ memory to \code{16} (MB).

\subsubsection{SSH server}
If you plan to log into the Raspberry Pi remotely you should enable
the \ssh\ server. If you will only log in via keyboard and monitor
connected directly to the Pi then you can choose to disable the \ssh\
server.
Select \code{Advanced Options} and then \code{SSH}. Choose the
appropriate option.

\subsubsection{I2C}
Enable the ARM \itwoc\ interface and kernel module.

\subsubsection{Expand Filesystem}
The filesystem should be expanded to use all of the (micro)\sd\
card. Advanced users planning to make a backup of the card may wish to
perform this step last so that the backup can be smaller.

Select \code{Expand Filesystem}. Choose \code{Finish} and then reboot.



\subsection{/dev/ttyAMA0 serial port setup}

Disable the console from running on \filename{/dev/ttyAMA0}. Edit
\filename{/boot/cmdline.txt} to remove the parts which relate to
\filename{ttyAMA0}. Remove
\begin{Cmd}
console=ttyAMA0,115200 kgdboc=ttyAMA0,115200
\end{Cmd}


Disable the \code{getty} process from running on
\filename{/dev/ttyAMA0}. Edit \filename{/etc/inittab}. Find the line
relating to \filename{ttyAMA0}. Either delete the line entirely or
comment it out by inserting a hash character (\#) at the start of the
line.

\subsection{Force HDMI output (optional)}
The default operation is to detect if a HDMI nomitor is connected at
boot time; if one is it will be used otherwise the composite video
output is selected. For the automatic detection to work the HDMI
monitor must be switch on when the Raspberry Pi boots up. To force
HDMI selection edit \filename{/boot/config.txt} as \rootUser
\begin{Cmd}
nano /boot/config.txt
\end{Cmd}

Ensure the following lines are enabled in the file (not commented out
with a \code{\#} symbol).
\begin{Cmd}
hdmi_force_hotplug=1
hdmi_drive=2  
\end{Cmd}

\subsection{Configure proxy server}
Not all networks require a proxy server (or web cache) to be used,
your network adminstrator should be able to advise. If it is necessary
the setting should be configured in two places.

As user \rootUser
\begin{Cmd}
nano /etc/environment  
\end{Cmd}

At the end of the file add a line similar to
\begin{Cmd}
http_proxy='http://proxyhost:port/'
https_proxy='http://proxyhost:port/'
\end{Cmd}
You must replace \code{proxyhost} and \code{port} with the correct
settings for your network. If the proxy server requires a username and
password the lines should be similar to
\begin{Cmd}
http_proxy='http://username:password@proxyhost:port/'
https_proxy='http://username:password@proxyhost:port/'
\end{Cmd}
Replace \code{username} and \code{password} with the values your
network administrator has provided.

Repeat for the procedure, as \rootUser
\begin{Cmd}
nano /etc/apt/apt.conf.d/10proxy
\end{Cmd}

Add a line similar to
\begin{Cmd}
Acquire::http::Proxy "http://proxyhost:port";
\end{Cmd}
Or, if a password is required, similar to
\begin{Cmd}
Acquire::http::Proxy "http://username:password@proxyhost:port";
\end{Cmd}
A separate line for HTTPS is not required in
\code{/etc/apt/apt.conf.d/10proxy}.

Proxy settings will not take effect until you log out and log back
in. Type
\begin{Cmd}
logout
\end{Cmd}
and then log back in.

\subsection{Update list of available packages}
As user \rootUser
\begin{Cmd}
apt-get update  
\end{Cmd}

\subsection{Remove swap file}
To prolong the life of the \sd\ card a swap file is not used. As user
\rootUser
\begin{Cmd}
apt-get remove dphys-swapfile  
\end{Cmd}

\subsection{Remove Wolfram Engine}
Wolfram Engine uses over \MB{450} and is not needed. Remove to save
valuable space on the \sd\ card. As user \rootUser
\begin{Cmd}
apt-get purge wolfram-engine
\end{Cmd}

\subsection{Install missing software packages}
As user \rootUser
\begin{Cmd}
apt-get install screen lsof python-pip ipython python-matplotlib \textbackslash
    python-scipy python-serial python-daemon python-lockfile \textbackslash
    avahi-daemon dnsutils i2c-tools python-smbus python3-smbus
\end{Cmd}

\subsection{Configure file system mount options}

As user \rootUser
\begin{Cmd}
nano /etc/fstab  
\end{Cmd}

Find the line where the root file system is mounted, it will look
similar to
\begin{Cmd}
/dev/mmcblk0p2  /               ext4    defaults,noatime  0       1
\end{Cmd}
Change the mount options (\code{defaults,noatime} in the example
above) so that the mount options are now
\filename{noatime,nodiratime}. The line should look similar to the one
below.
\begin{Cmd}
/dev/mmcblk0p2  /               ext4    noatime,nodiratime  0       1
\end{Cmd}

At the end of the \filename{/etc/fstab} add the following lines:
\begin{Cmd}[fontsize=\relsize{-2.5}]
# tmpfs for AuroraWatchNet temporary files. Files will be deleted on 
# a reboot, which is desirable for the NTP status files.
tmpfs  /home/pi/tmpfs  tmpfs  rw,size=100k,nr_inodes=1k,noexec,nodev,nosuid,uid=pi,gid=pi,mode=1700  0  0
\end{Cmd}

As user \rootUser
\begin{Cmd}
mkdir /home/pi/tmpfs
mount /home/pi/tmpfs
\end{Cmd}

\subsection{Automatically create symlinks for FTDI all-in-one}

As user \rootUser
\begin{Cmd}
nano /etc/udev/rules.d/90-usb_serial.rules
\end{Cmd}

Insert the following lines into the file if they are not present:
\begin{Cmd}[fontsize=\relsize{-3}]
# Have symlinks based on serial number for FTDI devices. Used for 
# awnetd_monitor
SUBSYSTEMS=="usb", KERNEL=="ttyUSB[0-9]*", ATTRS\{idVendor\}=="0403", ATTRS\{idProduct\}=="6001", SYMLINK+="tty_ftdi_\%s\{serial\}"  
\end{Cmd}

\subsection{Regenerate SSH host keys}

As user \rootUser
\begin{Cmd}
cd /etc/ssh
rm ssh_host_*_key\{,.pub\}
ssh-keygen -A
\end{Cmd}

\newpage
\section{Installing the AuroraWatchNet server software}

\subsection{Install the Git repository}
As user \piUser
\begin{Cmd}
git clone --recursive https://github.com/stevemarple/AuroraWatchNet.git 
git clone --recursive https://github.com/stevemarple/auroraplot.git
git clone --recursive https://github.com/stevemarple/Calunium.git
git clone --recursive https://github.com/stevemarple/xboot.git
mkdir \mytilde/bin
. \mytilde/.bashrc
cd \mytilde/bin
ln -s ../AuroraWatchNet/software/server/bin/awnetd.py
ln -s ../AuroraWatchNet/software/server/bin/send_cmd.py
ln -s ../AuroraWatchNet/software/server/bin/log_ip
ln -s ../AuroraWatchNet/software/server/bin/upload_data.py
cd \mytilde
\end{Cmd}

\subsection{Create configuration file}

As user \rootUser
\begin{Cmd}
mkdir /data
chown pi.pi /data
nano /etc/awnet.ini
\end{Cmd}

\todo[Create file contents, perhaps using a template copied from
the repository]

\newpage
\subsection{Configure \protect\filename{cron}}
\label{sec:cron-configuration}
As user \piUser
\begin{Cmd}
crontab -e
\end{Cmd}

In the \filename{nano} editor add the following text. 

\begin{Cmd}[fontsize=\smaller]
# Log IP address (useful for debugging)
@reboot /home/pi/bin/log_ip reboot > /dev/null 2>&1
@hourly /home/pi/bin/log_ip > /dev/null 2>&1
 
# Start the process which monitors the FTDI all-in-one
@reboot /home/pi/bin/awnetd_monitor.py start > /dev/null 2>&1
 
# Upload data
*/5 * * * * nice /home/pi/bin/upload_data.py -s today > /dev/null 2>&1
4 */6 * * * nice /home/pi/bin/upload_data.py -s yesterday > /dev/null 2>&1
 
# Check periodically that the server is running; restart if needed.
*/15 * * * * sudo /etc/init.d/awnetd start > /dev/null 2>&1
 
# Check NTP status
*/2 * * * * /home/pi/bin/check_ntp_status > /dev/null 2>&1

# Check wifi is up (uncomment only if using wifi, you may need to
# adjust the interface name from wlan0)
# */10 * * * * /home/pi/bin/network_watchdog -i wlan0 | logger -t network_watchdog
\end{Cmd}

\helpbox{Make sure you terminate the last line by pressing the
  \myreturn\ key.}

The \code{log_ip} lines periodically report that the Raspberry Pi is
operating. This helps the AuroraWatch administrators monitor which
stations are active. These reporting commands can be omitted if you
prefer.

Save the file, \keystroke{CTRL}-\keystroke{x}, \keystroke{y},
\myreturn.

\subsection{Configure \protect\filename{ifplugd}}

Configure \filename{ifplugd} to report when the network interface has
been assigned an \ip\ address, which helps the AuroraWatch
administrators monitor which stations are active. This step can be
omitted if you prefer. As user \rootUser
\begin{Cmd}
cd /etc/ifplugd/action.d
ln -s /home/pi/AuroraWatchNet/software/server/bin/log_ip
\end{Cmd}

\subsection{Automatically start the data recording daemon}
As user \rootUser
\begin{Cmd}
cd /etc/init.d
update-rc.d awnetd defaults
\end{Cmd}

%\subsection{Automatically start the daemon for the FTDI all-in-one}
%
% As user \rootUser
% \begin{Cmd}
% cd /etc/init.d
% update-rc.d awnetd_monitor defaults
% \end{Cmd}

\subsection{Configure python}

Create the python local site directory and create appropriate symbolic
links. As user \piUser
\begin{Cmd}
\mytilde/AuroraWatchNet/software/server/bin/setup.py --sudo
\end{Cmd}

The first time the command runs there will be some errors printed as
symbolic links are other configuration details are missing. Run the
same command a second time to confirm that the errors have been
corrected.


\subsection{Configure \protect\filename{ntp}}
Check that the current time is correct by typing
\begin{Cmd}
date --utc
\end{Cmd}
This will output the current date and time in \utc. If you aren't
certain what the current time in \utc\ is then you can check at this
web page, \url{https://www.google.co.uk/#q=utc+time}.

Check that the \ntp\ service is running correctly:
\begin{Cmd}
\mytilde{}pi/bin/check_ntp_status --log-level=info
\end{Cmd}
The last line should indicate ``NTP synchronized''. If it indicates
that NTP is not synchronized consult your network manager for the
correct \ntp\ settings on your network.



\section{Backup of SD card and expand filesystem}

If you did not expand the (micro)\sd\ card earlier then make a backup
(if you wish) and run
\begin{Cmd}
sudo raspi-config
\end{Cmd}
Select \code{Expand Filesystem}. Choose \code{Finish} and then reboot.
