\chapter{Raspberry Pi setup}

\section[SD card creation]{\sd\ card creation}

If your SD card already contains Raspbian you can skip to
section~\ref{sec:configuring-raspbian}.

Download the latest Raspbian image and copy to the \sd\ card following
the \href{http://www.raspberrypi.org/downloads}{instructions} on the
Raspberry Pi web site. \textbf{Copying the compressed image to a \fat\
  partition on the \sd\ card will not work}.

\section{Configuring Raspbian}
\label{sec:configuring-raspbian}
\helpbox{In the command window you can press the \keypress{Tab} key
  to have Linux complete the command or filename.}

\helpbox{If you are not familiar with the \code{nano} text editor read
  \href{http://www.howtogeek.com/howto/42980/the-beginners-guide-to-nano-the-linux-command-line-text-editor/}{The Beginner's Guide to Nano, the Linux Command-Line Text Editor}}

Raspbian is most easily configured by booting the new image. If you
are able to discover the \ip\ address (for instance, by checking the
\dhcp\ tables of your home router) you can do this over the network
using \ssh. Otherwise you must use attach a keyboard and monitor to the
Raspberry Pi. If you are familiar with Linux it is also possible to
edit the files by mounting the \sd\ card on another Linux system.

\subsection{/dev/ttyAMA0 serial port setup}

Disable the console from running on \filename{/dev/ttyAMA0}. Edit
\filename{/boot/cmdline.txt} to remove the parts which relate to
\filename{ttyAMA0}. Remove
\begin{Cmd}
console=ttyAMA0,115200 kgdboc=ttyAMA0,115200
\end{Cmd}


Disable the \code{getty} process from running on
\filename{/dev/ttyAMA0}. Edit \filename{/etc/inittab}. Find the line
relating to \filename{ttyAMA0}. Either delete the line entirely or
comment it out by inserting a hash character (\#) at the start of the
line.

\subsection{Raspbian configuration}

Log in as \piUser\ and run
\begin{Cmd}
sudo raspi-config
\end{Cmd}

\subsubsection{Change user password}
\textbf{If the default password has not been changed then do so now to keep
your system secure.}

\subsubsection{Internationalisation options}
\filename{cron} uses local time and the shift to and from daylight
saving time complicates the \filename{cron} tables. Set the Raspberry
Pi's timezone to \utc\ to avoid daylight saving.

Select \code{Internationalisation Options} and
then \code{Change Timezone}. For geographic area select %
\code{None of the above}, then select \code{\utc}. Select \code{OK}.

\subsubsection{Advanced options}
Select \code{Advanced Options} and then \code{Memory
  Split}. Set the \gpu\ memory to \code{16} (MB).

\subsubsection{Expand Filesystem}
Finally select \code{Expand Filesystem}. Although the first option
do this last. Choose \code{Finish} and then reboot.


\subsection{Configure proxy server}
Not all networks require a proxy server (or web cache) to be used,
your network adminstrator should be able to advise. If it is necessary
the setting should be configured in two places.

As user \rootUser
\begin{Cmd}
nano /etc/environment  
\end{Cmd}

At the end of the file add a line similar to
\begin{Cmd}
http_proxy='http://proxyhost:port/'
https_proxy='http://proxyhost:port/'
\end{Cmd}
You must replace \code{proxyhost} and \code{port} with the correct
settings for your network. If the proxy server requires a username and
password the lines should be similar to
\begin{Cmd}
http_proxy='http://username:password@proxyhost:port/'
https_proxy='http://username:password@proxyhost:port/'
\end{Cmd}
Replace \code{username} and \code{password} with the values your
network administrator has provided.

Repeat for the procedure, as \rootUser
\begin{Cmd}
nano /etc/apt/apt.conf.d/10proxy
\end{Cmd}

Add a line similar to
\begin{Cmd}
Acquire::http::Proxy "http://proxyhost:port";
\end{Cmd}
Or, if a password is required, similar to
\begin{Cmd}
Acquire::http::Proxy "http://username:password@proxyhost:port";
\end{Cmd}
A separate line for HTTPS is not required in
\code{/etc/apt/apt.conf.d/10proxy}.

Proxy settings will not take effect until you log out and log back
in. Type
\begin{Cmd}
logout
\end{Cmd}
and then log back in.

\subsection{Install missing software packages}
As user \rootUser
\begin{Cmd}
apt-get install screen lsof python-pip ipython python-matplotlib \textbackslash
    python-scipy python-serial python-daemon python-lockfile \textbackslash
    avahi-daemon dnsutils
\end{Cmd}

\subsection{Remove swap file}
To prolong the life of the \sd\ card a swap file is not used. As user
\rootUser
\begin{Cmd}
apt-get remove dphys-swapfile  
\end{Cmd}

\subsection{Configure file system mount options}

As user \rootUser
\begin{Cmd}
nano /etc/fstab  
\end{Cmd}

Find the line where the root file system is mounted, it will look
similar to
\begin{Cmd}
/dev/mmcblk0p2  /               ext4    defaults,noatime  0       1
\end{Cmd}
Change the mount options (\filename{defaults,noatime} in the example
above) so that the mount options are now
\filename{noatime,nodiratime}. The line should look similar to the one
below.
\begin{Cmd}
/dev/mmcblk0p2  /               ext4    noatime,nodiratime  0       1
\end{Cmd}





\section{Installing the AuroraWatchNet server software}

\subsection{Install the Git repository}
As user \piUser
\begin{Cmd}
git clone --recursive https://github.com/stevemarple/AuroraWatchNet.git 
git clone --recursive https://github.com/stevemarple/auroraplot.git
git clone --recursive https://github.com/stevemarple/Calunium.git
git clone --recursive https://github.com/stevemarple/xboot.git
mkdir \mytilde/bin
cd \mytilde/bin
ln -s ../AuroraWatchNet/software/server/bin/awnetd.py
ln -s ../AuroraWatchNet/software/server/bin/awnetd.py
ln -s ../AuroraWatchNet/software/server/bin/send_cmd.py
ln -s ../AuroraWatchNet/software/server/bin/log_ip
ln -s ../AuroraWatchNet/software/server/bin/upload_data.py
cd \mytilde
\end{Cmd}

\subsection{Install python numpy library}

As user \rootUser
\begin{Cmd}
dpkg -i /home/pi/python-numpy_1.7.1-3_armhf.deb
\end{Cmd}

\subsection{Configure python}

As user \piUser 

\helpbox{The first line uses backticks, which on most keyboards can be
  found on the key above TAB.}
\begin{Cmd}
user_site=`python -m site --user-site`
mkdir -p \$user_site
cp \mytilde/auroraplot/examples/example_auroraplot_custom.py \textbackslash
    \$user_site/auroraplot_custom.py
ln -t \$user_site -s \mytilde/auroraplot
\end{Cmd}


\subsection{Configure \protect\filename{cron}}
\label{sec:cron-configuration}
As user \piUser
\begin{Cmd}
crontab -e
\end{Cmd}

In the \filename{nano} editor add the following two lines to
periodically report that the Raspberry Pi is operating, make sure you
terminate the last line by pressing the \myreturn\ key. This helps
the AuroraWatch administrators monitor which stations are active. This
reporting step can be omitted if you prefer.
\begin{Cmd}
@reboot /home/pi/bin/log_ip reboot > /dev/null 2>&1
@hourly /home/pi/bin/log_ip > /dev/null 2>&1
\end{Cmd}

Save the file, \keystroke{CTRL}-\keystroke{x}, \keystroke{y},
\myreturn.

\subsection{Configure \protect\filename{ifplugd}}

Configure \filename{ifplugd} to report when the network interface has
been assigned an \ip\ address, which helps the AuroraWatch
administrators monitor which stations are active. This step can be
omitted if you prefer. As user \rootUser
\begin{Cmd}
cd /etc/ifplugd/action.d
ln -s /home/pi/AuroraWatchNet/software/server/bin/log_ip
\end{Cmd}

\subsection{Create configuration file}

As user \rootUser
\begin{Cmd}
mkdir /data
chown pi.pi /data
nano /etc/awnet.ini
\end{Cmd}

\todo[Create file contents, perhaps using a template copied from
the repository]

\subsection{Create init file for server daemon}
As user \rootUser
\begin{Cmd}
cd /etc/init.d
ln -s /home/pi/AuroraWatchNet/software/server/bin/awnetd.sh awnetd
update-rc.d  awnetd defaults
\end{Cmd}

\subsection{Configure \protect\filename{ntp}}
Check that the current time is correct by typing
\begin{Cmd}
date --utc
\end{Cmd}
This will output the current date and time in \utc. If you aren't
certain what the current time in \utc\ is then you can check at this
web page, \url{https://www.google.co.uk/#q=utc+time}.

If the time is incorrect you will need to configure the \ntp\
server. As user \rootUser\ edit \filename{/etc/ntp.conf}:
\begin{Cmd}
nano /etc/ntp.conf
\end{Cmd}

Find the line(s) which start \filename{server} and a insert
\filename{#} at the beginning of the line(s) to comment it(them)
out. Insert a similar line which begins with the word
\filename{server} but is followed by your own \ntp\ server
hostname. Your network adminstrator should be able to provide this
information. Finally restart \ntp; as user \rootUser
\begin{Cmd}
/etc/init/ntp restart
\end{Cmd}
