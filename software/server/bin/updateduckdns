#!/bin/sh

# Location of the config file
CONFIG_FILE="/etc/duckdns"

# Config file should look similar to
# TOKEN="Your token goes here"
# DUCKDNS_HOSTNAME="your-hostname"
# Can update with either the local IP address or the external IP address
# USE_LOCAL_IP_ADDRESS="1"

if [ -f "$CONFIG_FILE" ]; then
	. "$CONFIG_FILE"
	if [ -z "$TOKEN" ]; then
		echo "TOKEN not set"
	fi
	if [ -z "$DUCKDNS_HOSTNAME" ]; then
		DUCKDNS_HOSTNAME=$(hostname -s)
	fi
	if [ -z "$INTERFACE" ]; then
		INTERFACE="eth0"
	fi
else
	echo "Config file $CONFIG_FILE missing"
	exit 1
fi


# Request URL (see duckdns help)
url="https://www.duckdns.org/update?domains=${DUCKDNS_HOSTNAME}&token=${TOKEN}"

if [ -n "$USE_LOCAL_IP_ADDRESS" ]; then
	# Retrieve local IP address. Uncomment below to use local (internal)
	# IP address. Comment out line below to have duckdns use the external
	# IP address.
	ip=$(/bin/ip addr show dev "$INTERFACE" | awk '($1=="inet" && $6=="global"){split($2,a,"/");print(a[1])}')
	url="${url}&ip=${ip}"

	if [ -n "USE_IPV6" ]; then
		ipv6=$(/bin/ip addr show dev "$INTERFACE" | awk '($1=="inet6" && $4=="global"){split($2,a,"/");print(a[1])}')
		if [ -n "$ipv6" ]; then
			url="${url}&ipv6=${ipv6}"
		fi
	fi
fi

if [ -n "$VERBOSE" ]; then
	url="${url}&verbose=true"
	echo "URL is $url"
fi

# Update DuckDNS
curl -s -S -k "$url"
ret="$?"
echo ""
exit $ret
